---
author: Carlos Zamora @carlos-zamora
created on: 2020-07-10
last updated: 2020-07-10
issue id: [#885]
---

# Spec Title

## Abstract

This spec proposes a major refactor and repurposing of the TerminalSettings project. TerminalSettings would
 be responsible for exposing, serializing, and deserializing settings as WinRT objects for Windows Terminal. In
 doing so, Terminal's settings model is accessible as WinRT objects to existing components like TerminalApp,
 TerminalControl, and TerminalCore. Additionally, Terminal Settings can be used by the Settings UI or
 Shell Extensions to modify or reference Terminal's settings respectively.

## Inspiration

The main driver for this change is the Settings UI. The Settings UI will need to read and modify Terminal Settings.
 At the time of writing this spec, the Terminal Settings are serialized as objects in the TerminalApp project.
 To access these objects, the Settings UI would need to be a part of TerminalApp too, making it more bloated.

## Solution Design

### Terminal Settings Model: Objects and Projections

The objects/interfaces introduced in this section will be exposed as WinRT objects/interfaces
 within the `Microsoft.Terminal.Settings` namespace. This allows them to be interacted with across
 different project layers.

As before, a terminal instance will need a `Profile` (formerly `TerminalSettings`) to be able to update its settings.
`Profile` is a composition of...
- `ICore`: settings used to customize TerminalCore
- `IControl`: settings used to customize TerminalControl

Additionally, the top-level object holding all of the settings related to Windows Terminal will be
`Settings`. This will be a composition of...
- `AppSettings app`: global settings that generally affect TerminalApp
- `IObservableVector<Profile> profiles`: a list of `Profile` objects
- `IObservableMap<KeyChord, Action> keybindings`: a list of key bindings indexed by their unique key chord
- `IObservableMap<String, Action> commands`: a list of command palette commands indexed by their (autogenerated) name
- `IObservableMap<String, ColorScheme> schemes`: a list of ColorScheme objects indexed by their unique name
- `IVector<SerializationWarnings> warnings`: a list of warnings that occurred during serialization

Introducing a number of observable WinRT types allows for other components to subscribe to changes
 to these collections. A particular example of this being used can be seen in the (Settings UI: Preview section)[#settings-ui:-preview].



### Terminal Settings Model: Serialization and Deserialization

Introducing these `Microsoft.Terminal.Settings` WinRT objects also allow the serialization and deserialization
 logic from TerminalApp to be moved to TerminalSettings. `JsonUtils` introduces several quick and easy methods
 for setting serialization. This will be moved into the `Microsoft.Terminal.Settings` namespace too.

Deserialization will be an extension of the existing `JsonUtils` `ConversionTrait` struct template. `ConversionTrait`
 already includes `FromJson` and `CanConvert`. Deserialization would be handled by a `ToJson` function.


### Terminal Settings Model: Consumption

Separate projects can consume the Terminal Settings objects as needed.

TerminalApp would use...
- `profiles` to populate the dropdown menu
- `keybindings` to detect active key bindings and which actions they run
- `commands` to populate the Command Palette
- `warnings` to show a serialization warning, if any

TermControl would be given a `Profile` object, but as an `IControl` object. Whereas, TerminalCore
 would be passed the same `Profile` object, but as an `ICore` object. This is similar as is done today
 with `TerminalSettings` being split into `IControlSettings`, and `ICoreSettings`.


## UI/UX Design

N/A

## Capabilities

### Accessibility

N/A

### Security

N/A

### Reliability

N/A

### Compatibility

N/A

### Performance, Power, and Efficiency

## Potential Issues

### Deserialization

After deserializing the settings, injecting the new json into settings.json
 should not remove the existing comments or formatting.

## Future considerations

### Theming

When XAML Theming gets introduced, `TerminalSettings` will need to provide
 serialization and deserialization logic for the new JSON.


### Dropdown Customization

Profiles are proposed to be represented in an `IObservableVector`. They could be represented as an
 `IObservableMap` with the guid or profile name used as the key value. The main concern with representing
 profiles as a map is that this loses the order for the dropdown menu.

Once Dropdown Customization is introduced, `Settings` is expected to serialize the relevant JSON and expose
 it to TerminalApp (probably as an `IObservableVector<DropdownMenuItem>`). Since this new object would
 handle the ordering of profiles (if any), the `IObservableVector<Profile>` could be replaced with
 an observable map indexed by the profile name, thus even potentially providing an opportunity to
 remove guid as an identifier entirely.


## Resources

- [Spec: XAML Theming](https://github.com/microsoft/terminal/pull/5772)
- [Spec: Dropdown Customization](https://github.com/microsoft/terminal/pull/5888)
- [New JSON Utils](https://github.com/microsoft/terminal/pull/6590)
- [Spec: Settings UI](https://github.com/microsoft/terminal/pull/6720)
